<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="footer">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script sec:authorize="isAuthenticated()">
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBadge = document.getElementById('notification-badge');
            const notificationList = document.getElementById('notification-list');
            const notificationBell = document.getElementById('notificationBell');
            const csrfToken = document.querySelector('meta[name="_csrf"]'); // Untuk Spring Security CSRF jika aktif
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]'); // Untuk Spring Security CSRF jika aktif

            async function fetchUnreadCount() {
                try {
                    const response = await fetch('/api/notifications/unread-count');
                    if (!response.ok) return;
                    const data = await response.json();
                    
                    if (data.count > 0) {
                        notificationBadge.innerText = data.count > 9 ? '9+' : data.count;
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Gagal mengambil jumlah notifikasi:', error);
                }
            }
            
            async function fetchNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    if (!response.ok) return;
                    const notifications = await response.json();

                    notificationList.innerHTML = ''; // Kosongkan list
                    if (notifications.length === 0) {
                        notificationList.innerHTML = '<li><a class="dropdown-item text-center text-light" href="#">Tidak ada notifikasi.</a></li>';
                        return;
                    }

                    notifications.forEach(notif => {
                        const item = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = notif.link ? notif.link : '#';
                        link.classList.add('dropdown-item', 'text-wrap');
                        if (!notif.read) {
                            link.classList.add('fw-bold');
                        }
                        link.innerHTML = `
                            ${notif.message}
                            <small class="d-block text-muted">${new Date(notif.createdAt).toLocaleString()}</small>
                        `;
                        item.appendChild(link);
                        notificationList.appendChild(item);
                    });

                } catch (error) {
                    console.error('Gagal mengambil daftar notifikasi:', error);
                    notificationList.innerHTML = '<li><a class="dropdown-item text-center text-danger" href="#">Gagal memuat notifikasi.</a></li>';
                }
            }

            async function markAsRead() {
                try {
                     const fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                     };
                     // Tambahkan header CSRF jika ada
                    if(csrfToken && csrfHeader){
                        fetchOptions.headers[csrfHeader.content] = csrfToken.content;
                    }
                    await fetch('/api/notifications/mark-as-read', fetchOptions);
                    
                    notificationBadge.style.display = 'none';
                } catch (error) {
                    console.error('Gagal menandai notifikasi sebagai terbaca:', error);
                }
            }

            notificationBell.addEventListener('show.bs.dropdown', function () {
                fetchNotifications();
                markAsRead();
            });

            // Panggil saat halaman dimuat
            fetchUnreadCount();
            
            // Periksa notifikasi baru setiap 1 menit
            setInterval(fetchUnreadCount, 60000);
        });
    </script>
    </div>
</body>
</html>